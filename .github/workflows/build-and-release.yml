name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Triggers on version tags like v1.0.0
  workflow_dispatch:  # Allows manual triggering

jobs:
  build-macos:
    name: Build macOS App
    runs-on: macos-latest
    permissions:
      contents: write  # Required to create releases
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.0'
          channel: 'stable'
          cache: true
      
      - name: Get dependencies
        run: flutter pub get
      
      - name: Verify Flutter setup
        run: flutter doctor -v
      
      - name: Build macOS app
        run: flutter build macos --release
      
      - name: Create app archive
        run: |
          cd build/macos/Build/Products/Release
          zip -r dps150_control-macos.zip dps150_control.app
          cd -
      
      - name: Get version and tag
        id: version_info
        run: |
          if [ "${{ github.ref_type }}" == "tag" ]; then
            VERSION="${{ github.ref_name }}"
            TAG_NAME="${{ github.ref_name }}"
          else
            # Extract version from pubspec.yaml (format: version: 1.0.0+1)
            VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | sed 's/+.*//')
            VERSION="v${VERSION}"
            TAG_NAME="${VERSION}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag_name=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "Version: ${VERSION}"
          echo "Tag: ${TAG_NAME}"
      
      - name: Verify build artifact exists
        run: |
          if [ ! -f "build/macos/Build/Products/Release/dps150_control-macos.zip" ]; then
            echo "Error: Build artifact not found!"
            exit 1
          fi
          ls -lh build/macos/Build/Products/Release/dps150_control-macos.zip
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: build/macos/Build/Products/Release/dps150_control-macos.zip
          name: Release ${{ steps.version_info.outputs.version }}
          tag_name: ${{ steps.version_info.outputs.tag_name }}
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
